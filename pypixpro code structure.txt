#!/usr/bin/env python3

import logging
import os
import re
import shutil
import time
from dataclasses import dataclass
from enum import Enum, auto
from pathlib import Path
from typing import Dict, Optional, List, Union

from PySide6.QtWidgets import (
    QMainWindow, QMessageBox, QApplication, QLabel,
    QVBoxLayout, QWidget, QStackedWidget
)
from PySide6.QtCore import Qt, QMimeData, QUrl
from PySide6.QtGui import QPixmap
import sys

# Initialize logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    handlers=[
        logging.StreamHandler()
    ]
)

# Global type hints for clarity
FileList = List[str]
FilePath = Union[str, Path]

class DragDropWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        # Configure logging to both file and console
        self.log_path = Path.home() / "Desktop" / "Switch Log.txt"

        # Setup console handler for basic info
        console_handler = logging.StreamHandler()
        console_handler.setLevel(logging.INFO)
        console_handler.setFormatter(logging.Formatter('%(levelname)s: %(message)s'))

        # Configure root logger
        root_logger = logging.getLogger()
        root_logger.setLevel(logging.INFO)  # Set to INFO to capture all levels
        root_logger.addHandler(console_handler)

        logging.debug("Initializing DragDropWindow")

        self.is_processing = False
        self.failure_log_path = Path.home() / "Desktop" / "Switch Failure Log.txt"

        # Window configuration
        self.setWindowTitle("RyuSync")
        self.setFixedSize(441, 450)  # Smaller fixed window size

        # Set window flags to stay on top
        self.setWindowFlags(self.windowFlags() | Qt.WindowStaysOnTopHint)

        # Create central widget and layout
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        self.layout = QVBoxLayout(central_widget)
        self.layout.setContentsMargins(0, 0, 0, 0)

        # Create stacked widget for switching between image and summary
        self.stacked_widget = QStackedWidget()
        self.layout.addWidget(self.stacked_widget)

        # Setup image display
        self.setup_window_image()

        # Setup summary display
        self.setup_summary_display()

        # Enable drag and drop
        self.setAcceptDrops(True)

    def log_failure(self, error_message: str) -> None:
        """Log failures to desktop file instead of showing in summary"""
        timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
        try:
            with open(self.failure_log_path, "a") as f:
                f.write(f"[{timestamp}] {error_message}\n")
        except Exception as e:
            logging.error(f"Failed to write to failure log: {e}")

    def closeEvent(self, event) -> None:
        """Handle window close event"""
        event.accept()

    def setup_window_image(self) -> None:
        """Setup the window image"""
        try:
            self.image_widget = QLabel()
            # Get the application's root directory
            if getattr(sys, 'frozen', False):
                # Running as compiled
                application_path = sys._MEIPASS
            else:
                # Running from script
                application_path = os.path.dirname(os.path.abspath(__file__))

            image_path = os.path.join(application_path, "resources", "nxx.png")

            if not os.path.exists(image_path):
                logging.error(f"Image file not found: {image_path}")
                return

            pixmap = QPixmap(image_path)
            scaled_pixmap = pixmap.scaled(
                441, 450,  # Match window size
                Qt.IgnoreAspectRatio,
                Qt.SmoothTransformation
            )
            self.image_widget.setPixmap(scaled_pixmap)
            self.image_widget.setAlignment(Qt.AlignCenter)
            self.stacked_widget.addWidget(self.image_widget)

        except Exception as e:
            logging.error(f"Error loading window image: {e}")

    def setup_summary_display(self) -> None:
        """Setup the summary display"""
        self.summary_widget = QLabel()
        self.summary_widget.setAlignment(Qt.AlignLeft | Qt.AlignVCenter)  # Changed to left alignment
        self.summary_widget.setStyleSheet("""
            QLabel {
                background-color: black;
                color: white;
                font-family: 'Courier New', monospace;
                font-size: 18px;
                padding: 30px;
                margin: 20px;
                border: 2px solid #333;
                border-radius: 10px;
                font-weight: bold;
            }
        """)
        self.stacked_widget.addWidget(self.summary_widget)

    def dragEnterEvent(self, event) -> None:
        """Handle drag enter event"""
        if event.mimeData().hasUrls():
            event.acceptProposedAction()

    def dragLeaveEvent(self, event) -> None:
        """Handle drag leave event"""
        pass

    def dropEvent(self, event) -> None:
        """Handle dropped files/directories"""
        mime = event.mimeData()
        if not mime.hasUrls():
            return

        dropped_path = Path(mime.urls()[0].toLocalFile())
        if not dropped_path.exists():
            QMessageBox.warning(
                self,
                "Error",
                "The dropped path does not exist."
            )
            return

        try:
            logging.info(f"Dropped path: {dropped_path}")
            # Here you would add the logic to handle the dropped file or directory
            # For example, you might want to list the files in the directory:
            if dropped_path.is_dir():
                files = [f.name for f in dropped_path.iterdir() if f.is_file()]
                summary_text = f"Files in directory:\n" + "\n".join(files)
            else:
                summary_text = f"Dropped file: {dropped_path.name}"

            self.summary_widget.setText(summary_text)
            self.stacked_widget.setCurrentWidget(self.summary_widget)

            # Disable drag and drop after successful processing (optional)
            self.setAcceptDrops(False)

        except Exception as e:
            self.log_failure(f"Error processing {dropped_path}: {str(e)}")
            QMessageBox.warning(
                self,
                "Error",
                f"Failed to process files. Check the failure log on your desktop for details."
            )

def main() -> None:
    """Main entry point of the application"""
    app = QApplication(sys.argv)
    window = DragDropWindow()
    window.setWindowFlags(window.windowFlags() | Qt.WindowStaysOnTopHint)
    window.show()
    app.exec()

if __name__ == '__main__':
    main()

